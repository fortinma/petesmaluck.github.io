
<html>
<head>
<link href="//maxcdn.bootstrapcdn.com/bootstrap/3.3.0/css/bootstrap.min.css" rel="stylesheet">
    <script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js"></script>

    <script type="text/javascript" src="http://cdnjs.cloudflare.com/ajax/libs/d3/2.10.0/d3.v2.min.js"></script>

    <script type="text/javascript" src="http://maps.googleapis.com/maps/api/js?sensor=false"></script>
 <script type="text/javascript" src="map.js"></script>
 <script type="text/javascript" src="wards.js"></script>
 <script type="text/javascript" src="voteChart.js"></script>


    <style>
    html{
      padding:0;
      margin:0;
                overflow-y: scroll;
          overflow-x: hidden;
    }
    body{
          margin:0px;
          padding:0px;
          
    }
        #map {
          margin-top:50px;
            width: 100%;
            height: 600px;
        }
        .container-fluid{
       


        }
        
        .SvgOverlay, .SvgOverlay svg {
            position: absolute;
            top: 0;
            left: 0;
        }

        .SvgOverlay svg {
            position: absolute;
            top: -4000px;
            left: -4000px;
            width: 8000px;
            height: 8000px;        
          }
        
        .SvgOverlay path {
            stroke: black;
            stroke-width: 0px;
            fill: Orange;
            fill-opacity: .8;

        }
        .bottomBar{
          position:relative;
          width:100%;
          height:820px;
          background-color: rgba(0,0,0,0.7);
        }
        .navbar-default{
          background-color: rgba(0,0,0,0.7);
          border:solid 0px #000;
        }
        div.sideBar{
          width: 270px;
          height: 260px;
          background-color: rgba(0,0,0,0.7);
          position: fixed;
          top: 100px;
          right: 0px;
          border:solid 1px #444;
          border-top-left-radius: 5px;
          border-bottom-left-radius: 5px;
          padding:20px;
          color:white;
        }

        div.title{
          font-size: 18px;
          color:#fff;
          font-weight:100;
        }

        div.ward{
          font-size: 16px;
          color:#fff;
          font-weight:100;
        }

    .navbar-fixed-top{
      padding-left: 0;
      padding-right: 0;
    }
    .col-sm-12{
      padding:0px;
    }
    .navbar-brand {
      color:white;
      font-weight:100;
    }

.voteChart{
  width:100%;
  height:160px;
  color:black;
  border-radius:5px;
}
.voteChart rect {
  fill: steelblue;
}

.voteChart text {
  fill: white;
  font: 10px sans-serif;
  text-anchor: end;
}

.voteChart rect.ford{
  fill:#990000;
  stroke:white;
  stroke-width:1px;
  shape-rendering: crispEdges;
}
.voteChart rect.tory{
  fill:#003399;
  stroke:white;
  stroke-width:1px;
  shape-rendering: crispEdges;
}
.voteChart rect.chow{
  fill:#6600FF;
  stroke:white;
  stroke-width:1px;
  shape-rendering: crispEdges;
}
.title{
  height:25px;
}
.ward{
  height:30px;
}
text.barText{
  fill:#cdcccc;
  color:#cdcccc;
}
.bar text{
  fill:#cdcccc;
  color:#cdcccc;
}
path { 
    stroke: steelblue;
    stroke-width: 2;
    fill: none;
}

.axis path,
.axis line {
    fill: none;
    stroke: grey;
    stroke-width: 1;
    shape-rendering: crispEdges;

}
.wardNumber{
  pointer-events:none;
}
.wardBoundaries{
  pointer-events:none;
}
    </style>
</head>
<body>

    <!-- Fixed navbar -->
    <nav class="navbar navbar-default navbar-fixed-top" role="navigation">
      <div class="container">
        <div class="navbar-header">
          <a class="navbar-brand" href="#">2014 Municipal Election</a>
        </div>
      </div>
    </nav>


<div class="container-fluid">
  <div class="row">
    <div class="col-sm-12">
      <div id="map"></div>
      <div class="sideBar">
<div class="title"></div>
<div class="ward"></div>
<svg class="voteChart"></svg>
      </div>
      
    </div>
  </div>
  <div class="row">
    <div class="col-sm-12">
     <div class="bottomBar">

     </div>
   </div>
</div>
 </div>
    <script>

        $(function () {

      var $map=$("#map");
      var map = new google.maps.Map($map[0], {
          zoom: 12,
          zoomControl:false,
          mapTypeId: google.maps.MapTypeId.ROADMAP,
          center: new google.maps.LatLng(43.6525, -79.381667), // Toronto
          styles: [{featureType:"landscape",stylers:[{saturation:-100},{lightness:65},{visibility:"on"}]},{featureType:"poi",stylers:[{saturation:-100},{lightness:51},{visibility:"simplified"}]},{featureType:"road.highway",stylers:[{saturation:-100},{visibility:"simplified"}]},{featureType:"road.arterial",stylers:[{saturation:-100},{lightness:30},{visibility:"on"}]},{featureType:"road.local",stylers:[{saturation:-100},{lightness:40},{visibility:"on"}]},{featureType:"transit",stylers:[{saturation:-100},{visibility:"simplified"}]},{featureType:"administrative.province",stylers:[{visibility:"off"}]/**/},{featureType:"administrative.locality",stylers:[{visibility:"off"}]},{featureType:"administrative.neighborhood",stylers:[{visibility:"on"}]/**/},{featureType:"water",elementType:"labels",stylers:[{visibility:"on"},{lightness:-25},{saturation:-100}]},{featureType:"water",elementType:"geometry",stylers:[{hue:"#ffff00"},{lightness:-25},{saturation:-97}]}]        
        });
        

      var geoJson = provinces();
      var geoJsonWards = wards();
      var overlay = new google.maps.OverlayView();

      overlay.onAdd = function () {

        var layer = d3.select(this.getPanes().overlayMouseTarget).append("div").attr("class", "SvgOverlay");
        var svg = layer.append("svg")
          .attr("width", $map.width())
          .attr("height", $map.height())
        var adminDivisions = svg.append("g").attr("class", "divisions");
        var wardDivisions = svg.append("g").attr("class", "wards");

        overlay.draw = function () {
          var markerOverlay = this;
          var overlayProjection = markerOverlay.getProjection();

          // Turn the overlay projection into a d3 projection
          var googleMapProjection = function (coordinates) {
            var googleCoordinates = new google.maps.LatLng(coordinates[1], coordinates[0]);
            var pixelCoordinates = overlayProjection.fromLatLngToDivPixel(googleCoordinates);
            return [pixelCoordinates.x + 4000, pixelCoordinates.y + 4000];
          }
            

            var tooltip = function(d){
              var title = d3.select('div.title').append('text')
              .attr('class','title')
              .text(function() {return d.properties.AREA_ID});

              var ward = d3.select('div.ward').append('text')
              .attr('class','ward')
              .text(function() {return 'Area Short: ' + d.properties.AREA_SHORT});

var decimal = d3.format(".3n");

var x = d3.scale.linear()
    .domain([0, 100])
    .range([0, 170]);

var xAxis = d3.svg.axis().scale(x)
    .orient("bottom").ticks(5);

                  var bar = d3.select(".voteChart");

                    bar.append("rect")
                    .attr('class','bar Ford')
                        .attr("width", function() { return x(d.properties.Ford_perc * 100) ; })
                        .attr("height", 20)
                        .attr("x", function() { return 50; })
                        .attr("y", 30)
                        .attr("dy", ".35em");

                 
                    bar.append("text")
                    .attr('class','bar')
                        .attr("x", function() { return (75 + x(d.properties.Ford_perc * 100)); })
                        .attr("y", 40)
                        .attr("dy", ".35em")
                        .style('fill','cdcccc')
                        .text(function() { return decimal(d.properties.Ford_perc * 100); });
                  

                    bar.append("rect")
                    .attr('class','bar Tory')
                        .attr("width", function() { return x(d.properties.Tory_perc * 100) ; })
                        .attr("height", 20)
                        .attr("x", function() { return 50; })
                        .attr("y", 60)
                        .attr("dy", ".35em");

                    bar.append("text")
                    .attr('class','bar')
                        .attr("x", function() { return (75 + x(d.properties.Tory_perc * 100)); })
                        .attr("y", 70)
                        .attr("dy", ".35em")
                        .style('fill','cdcccc')
                        .text(function() { return decimal(d.properties.Tory_perc * 100); });

                    bar.append("rect")
                    .attr('class','bar Chow')
                        .attr("width", function() { return x(d.properties.Chow_perc * 100) ; })
                        .attr("height", 20)
                        .attr("x", function() { return 50; })
                        .attr("y", 90)
                        .attr("dy", ".35em");


                    bar.append("text")
                    .attr('class','bar')
                        .attr("x", function() { return (75 + x(d.properties.Chow_perc * 100)); })
                        .attr("y", 100)
                        .attr("dy", ".35em")
                        .style('fill','#cdcccc')
                        .text(function() { return decimal(d.properties.Chow_perc * 100); });

                   bar.append("text")
                    .attr('class','barText')
                        .attr("x", function() { return 45 ; })
                        .attr("y", 40)
                        .attr("dy", ".35em")
                        .style('font-size',12)
                        .text('Ford'); 

                   bar.append("text")
                    .attr('class','barText')
                        .attr("x", function() { return 45 ; })
                        .attr("y", 70)
                        .attr("dy", ".35em")
                        .style('font-size',12)
                        .text('Tory'); 

                   bar.append("text")
                    .attr('class','barText')
                        .attr("x", function() { return 45 ; })
                        .attr("y", 100)
                        .attr("dy", ".35em")
                        .style('font-size',12)
                        .text('Chow'); 



                          return[title,ward];
                        }
          //SUB-DIVISION BOUNDARIES
          path = d3.geo.path().projection(googleMapProjection);
          var polygons = adminDivisions.selectAll("path")
            .data(geoJson.features)
            .attr("d", path) // update existing paths
          .enter().append("svg:path")
            .attr("d", path)
            .attr('id', function(d) {return d.properties.AREA_LONG_} );


          //WHITE WARD BOUNDARIES
          pathWards = d3.geo.path().projection(googleMapProjection);
          

          var polygonsWards = wardDivisions.selectAll("path")
            .data(geoJsonWards.features)
            .attr("d", pathWards) // update existing paths
          .enter();

          polygonsWards.append("svg:path")
            .attr('class','wardBoundaries')
            .attr("d", pathWards)
            .attr('id', function(d) {return d.properties.AREA_LONG_} )
            .style('stroke','white')
            .style('stroke-width',2)
            .style('fill','none')
            
            //WARD NUMBERS - CENTERED
            polygonsWards.append("text").text(function(d){
                        return d.properties.SCODE_NAME;
                    })
                    .attr("x", function(d){
                        return path.centroid(d)[0];
                    })
                    .attr("y", function(d){
                        return  path.centroid(d)[1];
                    })
                    .attr("text-anchor","middle")
                    .attr('font-size','12pt')
                    .attr('class','wardNumber')
                    .style('fill','#fff');

                  

            polygons.style('fill', function(d){
              if (d.properties.Chow_perc > d.properties.Ford_perc && d.properties.Chow_perc > d.properties.Tory_perc){
                return '#6600FF'
              }
              if (d.properties.Ford_perc > d.properties.Tory_perc && d.properties.Ford_perc > d.properties.Chow_perc){
                return '#990000'
              }
              if (d.properties.Tory_perc > d.properties.Ford_perc && d.properties.Tory_perc > d.properties.Chow_perc){
                return '#003399'
              }

            })
            .style('opacity', function(d) {
              if (d.properties.Chow_perc > 0.8 || d.properties.Ford_perc > 0.8 || d.properties.Tory_perc > 0.8 ){
                return 1
              }
              if (d.properties.Chow_perc > 0.7 || d.properties.Ford_perc > 0.7 || d.properties.Tory_perc > 0.7 ){
                return 0.8
              }
              if (d.properties.Chow_perc > 0.6 || d.properties.Ford_perc > 0.6 || d.properties.Tory_perc > 0.6 ){
                return 0.6
              }
              if (d.properties.Chow_perc > 0.5 || d.properties.Ford_perc > 0.5 || d.properties.Tory_perc > 0.5 ){
                return 0.4
              }
              if (d.properties.Chow_perc > 0.4 || d.properties.Ford_perc > 0.4 || d.properties.Tory_perc > 0.4 ){
                return 0.3
              }
              else {return 0.2}
            })
            ;

            polygons.on('mouseover', tooltip)
            .on('mouseout', function() {
              var removeTitle = d3.select('.title text').remove();
              var removeWard = d3.select('.ward text').remove();
              var removeDivision = d3.select('.division text').remove();
              var removeFord = d3.selectAll('.bar').remove();
              var removeText = d3.selectAll('.barText').remove();
              return [removeTitle,removeWard, removeDivision, removeFord,removeText];
            });
        };

      };

      overlay.setMap(map);
      
      // GeoJSON for Mozambique's provinces

      
    });
      
  </script>


</body>
</html>
